<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>回测分析 - 量化交易平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>量化交易平台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i> 仪表盘
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/strategies">
                            <i class="fas fa-brain me-1"></i> 策略管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/backtest">
                            <i class="fas fa-vial me-1"></i> 回测分析
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/risk">
                            <i class="fas fa-shield-alt me-1"></i> 风控系统
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/orders">
                            <i class="fas fa-exchange-alt me-1"></i> 订单管理
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Controls Panel -->
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-cog me-2"></i>回测设置
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">选择策略</label>
                            <select class="form-select" id="strategySelect">
                                <option value="dual_ma">双均线策略</option>
                                <option value="macd">MACD策略</option>
                                <option value="rsi">RSI策略</option>
                                <option value="bollinger">布林带策略</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">交易资产</label>
                            <select class="form-select" id="assetSelect">
                                <option value="BTC-USDT">BTC-USDT</option>
                                <option value="ETH-USDT">ETH-USDT</option>
                                <option value="AAPL">AAPL (Alpaca)</option>
                                <option value="GOOGL">GOOGL (Alpaca)</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">开始日期</label>
                                <input type="date" class="form-control" id="startDate" 
                                    value="2023-01-01">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">结束日期</label>
                                <input type="date" class="form-control" id="endDate" 
                                    value="2023-12-31">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">初始资金</label>
                            <input type="number" class="form-control" id="initialCapital" 
                                value="100000" step="1000">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">手续费率 (%)</label>
                            <input type="number" class="form-control" id="commissionRate" 
                                value="0.1" step="0.01" min="0" max="1">
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="runBacktest()">
                            <i class="fas fa-play me-2"></i>开始回测
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <i class="fas fa-history me-2"></i>回测历史
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="backtestHistory">
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">双均线策略</h6>
                                    <small>2023-01-01 至 2023-12-31</small>
                                </div>
                                <p class="mb-1">BTC-USDT • 收益率: +12.34% • 夏普: 1.25</p>
                                <small class="text-muted">2023-12-20 14:30</small>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">MACD策略</h6>
                                    <small>2023-06-01 至 2023-11-30</small>
                                </div>
                                <p class="mb-1">ETH-USDT • 收益率: +8.76% • 夏普: 0.98</p>
                                <small class="text-muted">2023-11-25 09:15</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-chart-line me-2"></i>回测结果</span>
                        <div>
                            <button class="btn btn-sm btn-outline-light me-2" onclick="exportResults()">
                                <i class="fas fa-file-export"></i> 导出
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="resetBacktest()">
                                <i class="fas fa-redo"></i> 重置
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="text-center p-3 border rounded">
                                    <h6>总收益率</h6>
                                    <div id="totalReturn" class="h4 text-success">+0.00%</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 border rounded">
                                    <h6>夏普比率</h6>
                                    <div id="sharpeRatio" class="h4 text-info">0.00</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 border rounded">
                                    <h6>最大回撤</h6>
                                    <div id="maxDrawdown" class="h4 text-danger">-0.00%</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 border rounded">
                                    <h6>交易次数</h6>
                                    <div id="totalTrades" class="h4 text-primary">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="text-center p-3 border rounded">
                                    <h6>胜率</h6>
                                    <div id="winRate" class="h4 text-success">0.00%</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center p-3 border rounded">
                                    <h6>年化收益率</h6>
                                    <div id="annualReturn" class="h4 text-info">0.00%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <canvas id="equityCurveChart" height="300"></canvas>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-bar me-2"></i>月度回报</h6>
                                <canvas id="monthlyReturnsChart" height="200"></canvas>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-exclamation-triangle me-2"></i>风险分析</h6>
                                <canvas id="riskChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <i class="fas fa-table me-2"></i>交易明细
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>资产</th>
                                        <th>类型</th>
                                        <th>数量</th>
                                        <th>价格</th>
                                        <th>盈亏</th>
                                        <th>收益率</th>
                                    </tr>
                                </thead>
                                <tbody id="tradesTable">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            运行回测以查看交易明细
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let equityChart = null;
        let monthlyReturnsChart = null;
        let riskChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
        });

        function initializeCharts() {
            // Equity curve chart
            const equityCtx = document.getElementById('equityCurveChart').getContext('2d');
            equityChart = new Chart(equityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '权益曲线',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });

            // Monthly returns chart
            const monthlyCtx = document.getElementById('monthlyReturnsChart').getContext('2d');
            monthlyReturnsChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                    datasets: [{
                        label: '月度收益率',
                        data: [1.2, -0.5, 2.3, 1.8, -1.1, 0.9, 2.5, -0.3, 1.7, 2.1, -0.8, 1.5],
                        backgroundColor: function(context) {
                            const value = context.dataset.data[context.dataIndex];
                            return value >= 0 ? '#28a745' : '#dc3545';
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Risk chart
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            riskChart = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['低风险', '中风险', '高风险'],
                    datasets: [{
                        data: [60, 30, 10],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function runBacktest() {
            // Show loading state
            document.querySelector('.btn-primary').disabled = true;
            document.querySelector('.btn-primary').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>回测中...';

            // Simulate backtest process
            setTimeout(() => {
                // Mock results
                document.getElementById('totalReturn').textContent = '+12.34%';
                document.getElementById('totalReturn').className = 'h4 text-success';
                document.getElementById('sharpeRatio').textContent = '1.25';
                document.getElementById('maxDrawdown').textContent = '-2.34%';
                document.getElementById('totalTrades').textContent = '45';
                document.getElementById('winRate').textContent = '68.90%';
                document.getElementById('annualReturn').textContent = '15.23%';

                // Update equity chart with mock data
                const labels = Array.from({length: 100}, (_, i) => `Day ${i+1}`);
                const equityData = [];
                let currentValue = 100000;
                for (let i = 0; i < 100; i++) {
                    currentValue *= (1 + (Math.random() - 0.48) / 100);
                    equityData.push(currentValue);
                }

                equityChart.data.labels = labels;
                equityChart.data.datasets[0].data = equityData;
                equityChart.update();

                // Update trades table
                const tradesTable = document.getElementById('tradesTable');
                tradesTable.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>2023-0${i+1}-15 10:30</td>
                        <td>BTC-USDT</td>
                        <td>${i % 2 === 0 ? 'BUY' : 'SELL'}</td>
                        <td>${Math.floor(Math.random() * 10) + 1}</td>
                        <td>$${(40000 + Math.random() * 10000).toFixed(2)}</td>
                        <td class="${i % 3 === 0 ? 'text-success' : 'text-danger'}">
                            ${i % 3 === 0 ? '+' : '-'}$${(Math.random() * 500).toFixed(2)}
                        </td>
                        <td class="${i % 3 === 0 ? 'text-success' : 'text-danger'}">
                            ${i % 3 === 0 ? '+' : '-'}${(Math.random() * 2).toFixed(2)}%
                        </td>
                    `;
                    tradesTable.appendChild(row);
                }

                // Reset button
                document.querySelector('.btn-primary').disabled = false;
                document.querySelector('.btn-primary').innerHTML = '<i class="fas fa-play me-2"></i>开始回测';

                alert('回测完成！');

            }, 2000);
        }

        function exportResults() {
            alert('导出回测结果...');
        }

        function resetBacktest() {
            // Reset all results
            document.getElementById('totalReturn').textContent = '+0.00%';
            document.getElementById('totalReturn').className = 'h4 text-success';
            document.getElementById('sharpeRatio').textContent = '0.00';
            document.getElementById('maxDrawdown').textContent = '-0.00%';
            document.getElementById('totalTrades').textContent = '0';
            document.getElementById('winRate').textContent = '0.00%';
            document.getElementById('annualReturn').textContent = '0.00%';

            // Clear charts
            equityChart.data.labels = [];
            equityChart.data.datasets[0].data = [];
            equityChart.update();

            // Clear trades table
            const tradesTable = document.getElementById('tradesTable');
            tradesTable.innerHTML = '<tr><td colspan="7" class="text-center text-muted">运行回测以查看交易明细</td></tr>';
        }
    </script>
</body>
</html>